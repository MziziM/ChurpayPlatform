// frontend/src/App.jsx
import { useEffect, useState } from "react";

function App() {
  // Fallback to backend URL if env isn't baked into the build
  const apiBase = (import.meta.env.VITE_API_URL || "https://churpay-backend-wtgy.onrender.com").trim();

  const [health, setHealth] = useState(null);
  const [amount, setAmount] = useState("50.00");

  useEffect(() => {
    const check = async () => {
      try {
        const r = await fetch(`${apiBase}/api/health`);
        const text = await r.text();
        if (!r.ok) {
          setHealth({ ok: false, status: r.status, body: text });
          return;
        }
        try {
          const json = JSON.parse(text);
          setHealth(json);
        } catch {
          setHealth({ ok: false, status: r.status, body: text });
        }
      } catch (e) {
        setHealth({ ok: false, error: String(e) });
      }
    };
    check();
  }, [apiBase]);

  const handlePay = async () => {
    try {
      const r = await fetch(`${apiBase}/api/payfast/initiate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount })
      });
      const data = await r.json().catch(() => ({}));
      if (data.redirectUrl) {
        window.location.href = data.redirectUrl;
      } else {
        alert("Failed to start payment. " + JSON.stringify(data));
      }
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  return (
    <div style={{ padding: 24, fontFamily: "Inter, system-ui, Arial" }}>
      <h1>Churpay</h1>
      <p>Seamless payments made simple.</p>

      <div style={{ marginBottom: 12, fontSize: 12, color: "#6b7280" }}>
        API base: {apiBase}
      </div>

      <div style={{
        marginBottom: 12,
        padding: "8px 12px",
        borderRadius: 8,
        display: "inline-block",
        color: "#fff",
        background: health && health.ok ? "#22c55e" : "#ef4444"
      }}>
        Health: {health ? (health.ok ? "OK" : "ERROR") : "..."}
      </div>

      {health && !health.ok && (
        <pre style={{ marginTop: 8, maxWidth: 600, whiteSpace: "pre-wrap", fontSize: 12, color: "#6b7280" }}>
          {JSON.stringify(health, null, 2)}
        </pre>
      )}

      <div style={{ marginTop: 24 }}>
        <label>
          Amount (ZAR):{" "}
          <input
            type="number"
            step="0.01"
            value={amount}
            onChange={e => setAmount(e.target.value)}
            style={{ padding: 8, borderRadius: 6, border: "1px solid #d1d5db" }}
          />
        </label>
        <button
          onClick={handlePay}
          style={{
            marginLeft: 12,
            padding: "8px 16px",
            borderRadius: 6,
            background: "#3b82f6",
            color: "#fff",
            border: "none",
            cursor: "pointer"
          }}
        >
          Pay with PayFast (Sandbox)
        </button>
      </div>
    </div>
  );
}

export default App;

// frontend/src/main.jsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
)

// frontend/vite.config.js
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()]
})
